---
title: "03_map_EU_netMigration"
author: "Duc-Quang Nguyen"
date: "20 September 2016"
output: html_document
---


## Resources
* [Regional Statistics Illustrated](http://ec.europa.eu/eurostat/cache/RSI/#?vis=nuts2.population&lang=en)
* [Eurostat geodata](http://ec.europa.eu/eurostat/web/gisco/geodata/reference-data/administrative-units-statistical-units/nuts)
* [Crude rates of population change by NUTS 2 region](http://ec.europa.eu/eurostat/web/products-datasets/-/tgs00099)
# [NUTS geo](http://ec.europa.eu/eurostat/web/products-manuals-and-guidelines/-/KS-GQ-14-006)


```{r setup, include=FALSE}
downloadData <- F

eu.tgs00099.file <- "data/all_tgs00099.csv"
eu.migration.file <- "data/migration.2014.csv"
eu.geodata.file <- "input/eurostat_NUTS_geodata.Rdata"

colourText_bkbg <- '#262626'
border.color <- "#737373"


# Eurostat data tables
es.tb <- c('tgs00099')

library(readr)
library(tidyr)
library(dplyr)
library(magrittr)
library(countrycode)
library(ggplot2)
library(scales)
library(swiMap)
library(swiTheme)
library(forcats)

### Getting data in packages
library(eurostat)
library(htmltools)
library(shiny)
library(swiRcharts)
library(ggiraph)

require(rgdal)
require(rgeos)
require(maptools)
```



```{r load data, include = F}
### Get data from Eurostat
if(downloadData) {
  
  # Get migration data 
  dat <- get_eurostat(es.tb, time_format = "raw", cache = F, keepFlags = T)
  
  # wrange & discard 
  data <- label_eurostat(dat %>% select(-flags), eu_order = T, code = c("geo"))
  data$time <- as.numeric(data$time)
  # # add back data flags ??
  # data$flags <- dat$flags
  # filter for the last year and only net migratio indicator
  write.csv(data, eu.tgs00099.file, row.names = F)
  data %<>% 
    filter(indic_de == "Crude rate of net migration plus statistical adjustment", 
           time == 2014) %>% select(-time)
  write.csv(data, eu.migration.file, row.names = F)
  
  # Get geospatial data
  geo <- get_eurostat_geospatial(output_class = "df", resolution = "20")
  save(geo, file = eu.geodata.file)
} else {
  data <- read.csv(eu.migration.file)
  load(eu.geodata.file)
}

```

## Map

```{r helper mapping, echo = F}
# helper mapping 
mapTheme <- function(
  base_size = 14, base_family = "OpenSans-CondensedLight",
  title_family = "OpenSans-CondensedBold", subtitle_family = "OpenSans-CondensedLight",
  colour = colourText_bkbg
 ) { 
   theme_bw() + 
    theme(
      axis.line = element_blank(),
      axis.ticks = element_blank(), 
      axis.title = element_blank(), 
      axis.text = element_blank(),
      panel.grid = element_blank(),
      panel.grid.minor = element_blank(),
     # panel.border = element_blank(),
      plot.background = element_rect(fill = NULL),
      legend.text = element_text(colour = colourText_bkbg, size = 11, hjust = 1),
      legend.title = element_text(colour = colourText_bkbg, size = 12.5),
      legend.key.width = unit(1, "lines"),
      legend.key.height = unit(1, "lines"),
      #legend.position = "top",
      legend.position=c(0.86, 0.9), 
      legend.justification=c(0, 1),
      plot.margin = rep(unit(0,"null"),4),
      panel.margin = unit(0,"null")
    ) 
}
```


```{r map}

data$bins <- cut(data$values, breaks = c(-Inf, -10, -7.5, -5, -2.5, 0, 2.5, 5, 7.5, 10, Inf))

lang <- 'EN'


df <- filter(geo, STAT_LEVL_ == 2)
df <- cbind(df, data[match(as.character(df$NUTS_ID), as.character(data$geo_code)), c('geo', 'values', 'bins')])
ct <- filter(geo, STAT_LEVL_ == 0)

# get the country name 
df$iso2 <- strtrim(df$NUTS_ID, 2)


df$country <- countrycode(df$iso2, "iso2c", "country.name")

# Construct tooltip

df$tip <- paste0(
  '<h4>', as.character(df$country), '</h4><div class="tpsubtitle">',
  as.character(df$geo), '</div><div class = "tp">',
  "Net migration rate", ' <b>', df$values, '</b></div>')
df$tip <- gsub("'", "_", gsub("\\\n", "", df$tip))
  

map <- ggplot() + 
  geom_polygon_interactive(
    data = df,
    aes( x = long, y = lat, group = group, fill = bins, data_id = as.numeric(id), tooltip = tip)
  ) +
  # coord_map("conic", lat0 = 30 , xlim = c(-9.5, 44), ylim = c(34.5, 72)) #+ 
  coord_quickmap(expand = F)  +  xlim(c(-11, 45)) + ylim(c(35, 71.5)) +
  mapTheme() +
  labs(x=NULL, y=NULL) + 
  scale_fill_manual(values = swi_dpal3) +
  geom_polygon(data = ct, aes(x=long,y=lat,group=group, id = group),
               fill =NA, colour = "#3B3B3B", size = 0.15)

tooltip_css <- "background-color:#f2f2f2;padding:0px;margin:0px;border-radius:5px;"
  
imap <- ggiraph(
  code = {print(map)}, 
  width = 1, 
  pointsize = 9,
  zoom_max = 2, 
  tooltip_extra_css = tooltip_css,
  fontname_sans = 'Open Sans Condensed'
)
  
html.outfile <- paste0("regionalEUmap_netMigration_", lang, ".html")
    

save_html(
  tags$html(
    tags$head(includeHTML("stylesMap.html")),
    tags$body(    
     # h2(txt["title1", lang]),
     # div(class = "descr", HTML(paste0(txt["descr1", lang],  '&nbsp; &nbsp; <img src="Interactive_icon.svg.png" width="23" align="top">'))),
      div(class="container", imap),
      HTML(iframeresizer)  
    )), file = html.outfile, libdir = "js"
)

# move stuff
fileToMove <- c(html.outfile, "js")
file.rename(from = fileToMove, to = paste0("output/", fileToMove))
    
    
```