---
title: "02 chart EU migrant"
author: "Duc-Quang Nguyen"
date: "19 September 2016"
output: html_document
---

## Resources

* [Libre circulation](http://www.touteleurope.eu/les-politiques-europeennes/marche-interieur/synthese/la-libre-circulation-des-personnes.html)
* [SEM libre circulation](https://www.sem.admin.ch/sem/fr/home/themen/fza_schweiz-eu-efta.html) AELE + EU
* To check the graphic!! [Eurostat Non-national population by group of citizenship](http://ec.europa.eu/eurostat/statistics-explained/index.php/File:Non-national_population_by_group_of_citizenship,_1_January_2015_(¹)_YB16.png)

## Related

* [Metrocosm Which EU Country Has the Most Citizens Living Abroad?](http://metrocosm.com/eu-diaspora-map/)
* [Metrocosm The Ins and Outs of Immigration in the European Union](http://metrocosm.com/mapping-eu-immigration/)
* [Intra-european living elsewhere](http://www.economist.com/news/europe/21704813-eus-cherished-free-movement-rights-are-less-secure-they-seem-europes-scapegoat)

## Text snippets

Nationalité des ressortissants. Pour les pays pour lequels procesus naturalisation facile, part d'étrangers. 

* The number of people residing in an EU Member State with citizenship of a non-member country on 1 January 2015 was 19.8 million, representing 3.9 % of the EU-28 population. In addition, there were 15.3 million persons living in one of the EU Member States on 1 January 2015 with the citizenship of another EU Member State. [Eurostat Migration and migrant population statistics](http://ec.europa.eu/eurostat/statistics-explained/index.php/Migration_and_migrant_population_statistics) 

* [Libre circulation et l'Union europénne](http://www.vie-publique.fr/chronologie/chronos-thematiques/libre-circulation-personnes-union-europeenne.html)  En 1985, cinq pays (l’Allemagne, la Belgique, la France, le Luxembourg et les Pays-Bas) décident d’étendre aux ressortissants de pays tiers le bénéfice de la libre circulation sur leur territoire et de créer entre eux un territoire sans frontières, l’Espace Schengen, du nom de la ville luxembourgeoise où est signé le premier accord. En 2015, l’espace Schengen regroupe 26 pays et concerne près de 420 millions d’habitants. 22 pays membres de l’Union européenne ont adhéré aux Accords de Schengen (le Royaume-Uni, l’Irlande, la Bulgarie, la Roumanie, Chypre et la Croatie n’en font pas partie). L’Espace Schengen comprend aussi quatre États non-membres de l’UE (Norvège, Islande, Suisse et Liechtenstein)

* [OECD migration outlook 2016](http://www.oecd-ilibrary.org/social-issues-migration-health/international-migration-outlook-2016_migr_outlook-2016-en)

# Text

## La libre circulation et l'immigration en Europe. 

Montée de la droite populiste en Europe, Brexit, vote en Suisse en faveur d'un contrôle plus strict de l'immigration. 

L'immigration est un sujet brûlant en Europe. Montée de la droite populiste dans plusieurs pays, la libre circulation est sous pression. Mais quand est-il de la migration intra-européenne. Les profils de l'immigration est très différent au sein de l'Europe. Décryptage en graphiques.



Avec la montée de la droite populiste. It is easily forgotten that migration from southeast to northwest has a significant impact on a drain of talent away from the southeast to the northwest.


Ca fait aujourd'hui plus de 14 ans que la Suisse a rejoint l'Union Européenne sur l’accord de la libre circulation. Ces accords permettent aux citoyens membres de ce club d'étudier, de travailler et de prendre leur retraite n'importe d'où dans l'Union Européenne ainsi que dans l'AELE (Norvège, Suisse, Lichenstein Islande).. La libre circulation complémentent les 3 autres libertés de l'UE, que sont la liberté des biens, des capitaux et des services. 


Qui considère-t-on comme «immigré»?
Afin d'avoir une idée de ce que pourrait résulter en l'absence de libre circulation.  comparer Les caractéristiques de la population étrangère dépendent de plusieurs facteurs: l’histoire des flux migratoires, l’accroissement naturel de la population étrangère et les naturalisations. En Suisse où le processus de naturalisation 



Mais la libre circulation est sous pression, avec l'acceptation du Brexit cette année et en Suisse. 
Il clair qu'
Sans même mentionner les tensions au sein de l'Union pour répondre aux défis de l'afflux de demandeurs d'asile. 



Après l'onde de choc provoquée par le Brexit, la Suisse se pose la question de l’avenir de sa voie bilatérale.



Ca fait aujourd'hui plus de La libre circulation est sous pression. 
le peuple a ainsi approuvé à une courte majorité une initiative populaire demandant un contrôle plus strict de l'immigration.

Sans mentionnier ici l'afflux de demandes d'asiles 

## Studio

L’immigration est au coeur des débats politiques en Europe avec en ligne de mire la libre circulation des personnes. Les profils de l'immigration diffèrent largement au sein des pays européens. Un tour d'horizon et décryptage en graphiques.

content/42469286

Ca fait aujourd'hui plus de 14 ans que l’accord sur la libre circulation des personnes entre la Suisse et l'Union Européenne  (UE) est en vigueur. Avec cet accord, les citoyens membres de ce club select peuvent étudier, travailler et prendre leur retraite n'importe d'où dans l'UE et dans l'Association européenne de libre-échange (AELE, comprenant la Norvège, la Suisse, le Liechtenstein et l'Islande). La libre circulation des personnes complémentent les 3 autres libertés de l'UE garanties par le marché unique, la liberté des biens, des capitaux et des services. 

Au Royaume-Uni tout comme en Suisse, la libre circulation des personnes est potentiellement remise en question avec la volonté exprimée de leur peuple de mieux pouvoir réguler l'immigration. Comme discuté dans l'épisode précédent, la majorité des immigrants en Europe proviennent du vieux continent et la libre circulation favorise évidemment cette migration intra-européenne. 

Comme illustré par la carte ci-dessus, la balance migratoire diffère largement dans différentes regions d'Europe. Sans surprise, ce sont les pays et régions les plus riches qui attirent le plus d'immigrés. La Suisse, l'Allemagne, l'Autriche, le Royaume-Uni ainsi que les pays scandinaves affichent une balance migratoire largement positive.

Parmis tous les états membres de l'UE et de l'AELE, on dénombrait plus de 37,7 millions de ressortissants étrangers en 2015, soit près de 8% de la population. Plus de 45% de ces étrangers disposent de la nationalité d'un autre pays membre.



Le graphique ci-dessous présente la nationalité des immigrants pour différents pays d'Europe. Une large proportion d'immigrants proviennent de l'Europe de l'Est et du Sud. Les Roumains et les Polonais représentent à eux seuls près de 30% des etrangers de l'UE + AELE, mais les profils de l'immigration en Europe diffèrent largement d'un pays à l'autre. 

Différentes études ont montré la libre circulation des personnes ont un effet principalement positif pour les pays hôtes. Contrairement à certains discours populistes, les immigrants rapportent généralement d'avantage d'argent à l'Etat que leurs coûts. https://www.oecd.org/migration/OECD%20Migration%20Policy%20Debates%20Numero%202.pdf

La libre circulation a largement contribué à la croissance de l'emploi https://www.seco.admin.ch/seco/fr/home/seco/nsb-news.msg-id-49206.html


Mais pour les pays nataux de immigrants, la libre circulation peut également poser problème. La fuite des plus jeunes et des plus éduqués peuvent être un frein à la croissance tant économique que démographique. 


content/42409190

content/42392104

content/42463826









```{r setup, include=FALSE}
printTest <- F
translation.file <- 'input/European migration waffe - Sheet1.csv'

iso2.sub <- c('CH', 'DE', 'IT', 'GB', 'ES', 'PT','AT', 'RO')
infile <- "input/data_pop_2015.csv"

library(readr)
library(tidyr)
library(dplyr)
library(magrittr)
library(countrycode)
library(ggplot2)
library(scales)
library(swiMap)
library(swiTheme)
library(forcats)
library(RColorBrewer)
### Getting data in packages
library(eurostat)
library(waffle)
library(htmltools)
library(swiRcharts)

```

```{r load data, echo = F, message = F}
data <- read_csv(infile)

# hack for UK and GR iso code 
data$citizen_code<- gsub("UK", "GB", data$citizen_code)
data$geo_code<- gsub("UK", "GB", data$geo_code)
data$citizen_code<- gsub("EL", "GR", data$citizen_code)
data$geo_code<- gsub("EL", "GR", data$geo_code)

eu.ct <- c(eu_countries[,1], efta_countries[,1])
eu.ct <- gsub("UK", "GB", eu.ct)
eu.ct <- gsub("EL", "GR", eu.ct)

# translation
txt <- read.csv(translation.file, row.names = 1, stringsAsFactors = F)
# discard incomplete translations
cidx <- unique(which(txt =="" | is.na(txt), T)[,2])
if(length(cidx > 0)) {
  warning(paste(colnames(txt)[cidx], collapse = "\t"), " languages will be discarded!", "\n")
  txt <- txt[,-cidx, drop = F]
}
colnames(txt)

# Some test
if(printTest) {
data %>% filter(geo_code == "CH") %>% as.data.frame()
data %>% filter(geo_code %in% iso2.sub) %>% group_by(citizen_code, citizen) %>%
  summarise(tot = sum(values)) %>% ungroup() %>% arrange(desc(tot)) %>% head(20)  
}

## EU stats

keyn <- data %>% filter(geo_code %in% eu.ct)


```
### Compute the sum for EU-28 + EFTA

```{r get EU & EFTA totals, results='asis'}

## for all EU & EFTA countries check how complete is the citizen data
eu.test <- data %>% filter(geo_code %in% eu.ct) %>% group_by(geo_code) %>%
  summarise(forNat = length(values)) %>% ungroup() %>% as.data.frame()

cat("### countries missing !!!!")
cat(eu.ct[!eu.ct %in% eu.test$geo_code])

# create a special structure to plot as waffle with the sums of all EU & EFTA countries
eu <- data %>% filter(geo_code %in% eu.ct) %>% group_by(citizen, citizen_code) %>%
  summarise(values = sum(values)) %>% ungroup()

eu.sums <- data %>% filter(geo_code %in% eu.ct) %>% group_by(geo) %>% 
  summarise(
    TOTAL = first(TOTAL),
    NAT = first(NAT),
    FOR = first(FOR),
    EFTA_FOR = first(EFTA_FOR),
    EU28_FOR = first(EU28_FOR)
  ) %>% ungroup()

eu.2<- t(as.data.frame(colSums(eu.sums[,-1])))
rownames(eu.2) <- NULL
eu <- cbind(eu, eu.2)

eu$geo <- "EU_EFTA"
eu$geo_code <- 'EU'

eu$EUEFTA <- eu$EFTA_FOR + eu$EU28_FOR
eu %<>% select(-EFTA_FOR, -EU28_FOR) %>% arrange(desc(values))



eut <- data %>% filter(geo_code %in% eu.ct) %>% group_by(citizen) %>%
  summarise(totNat = sum(values)) %>% ungroup() %>% arrange(desc(totNat)) %>%
  mutate(TOT = sum(totNat))

eut$citizen_code <- as.character(unlist(data[match(eut$citizen, data$citizen), 'citizen_code']))
eut$share <- eut$totNat / eut$TOT
eut$euefta <- eut$citizen_code %in% eu.ct
eut$continent <- countrycode(eut$citizen_code, "iso2c", "continent")

# hack
eut[which(eut$citizen_code %in% c("XK", "TW")), 'continent'] <- c("Europe", "Asia")
if(any(is.na(eut$continent))) {stop()}


if(printTest) {
  head(eut, 20)
}

library(treemap)
library(highcharter)

dff <- treemap(eut, draw = T, index = c("continent", "citizen"), vSize = "totNat", type = "index")
```



```{r prepare data for waffle chart, echo = F}

# compute the sum EFTA + EU-28 foreigners by country
data$EUEFTA <- data$EFTA_FOR + data$EU28_FOR
data %<>% select(-EFTA_FOR, -EU28_FOR)

#dd <- data %>% filter(geo_code == "IT") %>% arrange(desc(values))

mergeCit <- function(df, n = 6, base = 1000) {
  df %<>% arrange(desc(values))
  topN <- df %>% select(citizen_code) %>% head(n) %>% unlist(use.names = F)
  
  # get the total for EUEFTA and non-EU/EFTA countries
  euefta <- df %>% filter(citizen_code %in% topN, citizen_code %in% eu.ct) %>% 
    summarise(tot = sum(values)) %>% unlist()
  non_euefta <- df %>% filter(citizen_code %in% topN, !citizen_code %in% eu.ct) %>% 
    summarise(tot = sum(values)) %>% unlist()

  ddd <- df %>% select(citizen_code, geo_code, values, TOTAL, FOR) %>% filter(citizen_code %in% topN)
  
  ddd <- rbind(ddd, 
        data.frame(citizen_code = "OU", geo_code = ddd$geo_code[1], 
                   TOTAL = ddd$TOTAL[1], FOR = ddd$FOR[1], values = df$EUEFTA[1] - euefta),
        data.frame(citizen_code = "OT", geo_code = ddd$geo_code[1],  
                   TOTAL = ddd$TOTAL[1], FOR = ddd$FOR[1], values = df$FOR[1] - non_euefta- df$EUEFTA[1])
  )
  
  ddd$share <- round((ddd$values / ddd$TOTAL) * base)
  ddd
}

### Subset data by iso2.sub and merge foreigner citizenships! 
dd <- filter(data, geo_code %in% iso2.sub)
df <- do.call(rbind, by(dd, dd$geo_code, mergeCit))
df <- rbind(df, mergeCit(eu))

# Get all foreign nationality
cit <- df %>% group_by(citizen_code) %>% summarise(tot = sum(share)) %>%
  ungroup() %>% arrange(desc(tot))

colors <- c( "#dbd6db", "#e5dbcd",
            "#ab3d3f", "#666699", "#669999", "#663333", "#336666", "#366096", "#333366", "#996699", "#ac673e", "#3a9736", "#999966", "#666633", "#89a23a", "#368596", "#996666", 
            brewer.pal(name = "Set3", n = 12))
cit$color <-  c(colors, colorRampPalette(colors = c("#336666", "#ab3d3f"))(nrow(cit)- length(colors)))

totF <- df %>% group_by(geo_code) %>% summarise(tot = sum(share)) %>% ungroup() %>% arrange(desc(tot))


wtheme <- function(title.font = "OpenSans-CondensedBold", base.font = "OpenSans-CondensedLight", legend.text.size = 16) {
  theme(
    plot.title = element_text(family = title.font, size = 21, margin = margin(b = 29), colour = "#404040"),
    legend.title = element_text(family = base.font, size = 12, color = "#595959") ,
    legend.text = element_text(family = base.font, size = legend.text.size),
    legend.key.width = unit(1.6, "lines"),
    legend.key.height = unit(1, "lines"),
    legend.position=c(0,1.08), 
    legend.justification=c(0, 0)
  ) 
}

```

## waffle chart

```{r waffle chart}
nrow <- 5
size <- 1
ncol <- floor(max(totF$tot) / nrow)

lang <- 'FR'

for(lang in colnames(txt)) {
  
  # Loop by iso2 and create the 
  wf <- lapply(totF$geo_code, function(iso) {
    cat("\n", iso)
    
    ddd <- filter(df, geo_code == iso, share > 0)
    pc <- round((ddd$FOR[1]/ ddd$TOTAL[1])  * 100, 1)
    # order whether citizen is a EUFTA or not country
    eu.log <- ddd$citizen_code %in% c(eu.ct, "OU") 
    ddd <- ddd[c(which(eu.log), which(!eu.log)),]
    
    # vector: values & translated country names
    dddd <- structure(
      ddd$share, names = countryTranslation(ddd$citizen_code, lang)[,-1])
    # for non-exsistent tranlsation get it from the google sheet
    codes <- unlist(ddd[which(is.na(names(dddd))), "citizen_code"], use.names = F)
    names(dddd)[which(is.na(names(dddd)))] <- txt[codes, lang]
    if(any(is.na(names(dddd)))) {stop ()}
    # add space at the end of the country translation
    names(dddd) <- paste0(names(dddd), "  ")
    
    title <- paste0(ifelse(iso == "EU", txt['EU', lang], countryTranslation(iso, lang)[-1]), "\n")
    pad <- ncol - floor(sum(ddd$share) / nrow)
    
    legend.text.size <- ifelse(lang == 'ZH', 14, 16)
    
    suppressWarnings(
      waffle(
        dddd, rows = nrow , size=size, pad = pad, 
        colors = cit[match(ddd$citizen_code, cit$citizen_code), 'color'] %>% 
          unlist(use.names = F), legend_pos = "top", 
        title = title, xlab = "\n") +
        wtheme(title.font = txt["title.font", lang], base.font = txt["base.font", lang], legend.text.size = legend.text.size) + 
        guides(fill=guide_legend(nrow=2,byrow=F, title = paste0(pc, txt["subtitle1", lang])))
    )
  })
  
  w.path <- paste0("output/waffle_chart_" , lang, ".png")
  w.html <- paste0("waffle_charts_" , lang, ".html")
  
  png(w.path,  res = 250, pointsize = 12, height = 4700, 
      width = 2000)
  iron( wf[[7]], wf[[1]], wf[[2]], wf[[3]], wf[[4]], wf[[5]], wf[[6]],  wf[[8]], wf[[9]])
  dev.off()
  
  source <- paste0(
    txt['source', lang], ": ", htmlLink(txt['source.url', lang], txt['source.name', lang]), " | ",
    txt['code', lang], ": ", htmlLink(txt['code.url', lang], txt['code.name', lang]), " | ",
    htmlLink("http://www.swissinfo.ch", 'swissinfo.ch'), " | ",
    htmlLink("https://twitter.com/duc_qn", '@duc_qn')    
  )
  footer <- paste0(txt["footer1", lang], "<br>", txt["footer2", lang])
  
  save_html(
    tags$html(
      tags$head(includeHTML("styles.html")),
      tags$body(    
        h2(txt["title1", lang]),
        div(class = "descr", HTML(txt["descr1", lang])),
        h3(txt["h3", lang]),
        div(img(src = basename(w.path), width= "100%")),
        div(class = "footer", HTML(footer)),
        div(id = "cite", HTML(source)),
        HTML(iframeresizer)  
      )), file = w.html
  )
  
  # move stuff
  file.rename(from = w.html, to = paste0("output/", w.html))    
}


    
```

